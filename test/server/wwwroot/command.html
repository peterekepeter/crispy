<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>My Todo List</title>
    <!-- this is where the magic happens. -->
    <script src="api/crispy"></script>
</head>
<body>
    <script>
        let connected = true;
        // render todo items from C#
        async function main(){
            try{
                if (connected == false){ console.info("reconnecting"); }
                var command = await api.command.getNextCommand();
                if (connected == false){ 
                    console.info("connection established");
                    connected = true;
                }
            }
            catch(exception)
            {
                if (connected == true){
                    connected = false;
                    console.info("seems to be disconnected");
                }
                console.error(exception);
                setTimeout(main, 100);
                return;
            }
            var success = false;
            try {
                var result = eval(command.js);
                if (result != null && result.then != null){
                    result = await result;
                }
                if (typeof result !== 'string') 
                { 
                    if (result === undefined)
                    {
                        result = 'undefined';
                    }
                    if (typeof result === 'object'){
                        result = JSON.stringify(result);
                    }
                    else 
                    {
                        result = ''+result;
                    }
                }
                success = true;
            }
            catch (exception){
                console.error(exception);   
                var result = exception;
            }
            try{
                await api.command.submitResult(command.id, success, result);
            } 
            catch
            {
                console.warn("Might have failed submitting result.",result);
            }
            setTimeout(main, 1);
        }
        // initialize
        console.log("init");
        main();
    </script>
</body>
</html>